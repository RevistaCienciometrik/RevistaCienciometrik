<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de Mensajes - Revista Cienciometrik</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <mi-header></mi-header>

    <div class="container">
        <aside class="sidebar">
            <h3>Panel de Administración</h3>
            <nav>
                <ul>
                    <li><a href="index.html"><i class="fas fa-home"></i> Inicio</a></li>
                    <li><a href="publicaciones.html"><i class="fas fa-book"></i> Publicaciones</a></li>
                    <li><a href="autores.html"><i class="fas fa-users"></i> Autores</a></li>
                    <li><a href="contactanos.html"><i class="fas fa-envelope"></i> Contáctanos</a></li>
                    <li><a href="admin.html"><i class="fas fa-user-shield"></i> Administrar Mensajes</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <section class="section">
                <h2>Bandeja de Entrada de Mensajes</h2>

                <div class="message-filters">
                    <span class="filter-group-title"><i class="fas fa-filter"></i> Filtrar por Estado:</span>
                    <button id="filter-all" class="active"><i class="fas fa-inbox"></i> Todos los Mensajes</button>
                    <button id="filter-read"><i class="fas fa-eye"></i> Leídos</button>
                    <button id="filter-unread"><i class="fas fa-envelope-open"></i> No Leídos</button>
                    <button id="filter-deleted"><i class="fas fa-trash-alt"></i> Eliminados</button>
                </div>

                <div class="date-filters">
                    <span class="filter-group-title"><i class="fas fa-calendar-alt"></i> Filtrar por Fecha:</span>
                    <button id="filter-today">Hoy</button>
                    <button id="filter-yesterday">Ayer</button>
                    <button id="filter-last-week">Última Semana</button>
                    <button id="filter-last-month">Último Mes</button>
                    <button id="filter-last-year">Último Año</button>
                    <button id="filter-date-all" class="active">Todas las Fechas</button>
                </div>

                <div id="messages-container" class="message-list">
                    <p id="no-messages" style="text-align: center; color: #777; display: none;">No hay mensajes para mostrar en esta categoría.</p>
                </div>
            </section>
        </main>
    </div>

    <mi-footer></mi-footer>

    <script src="header_admin.js" type="module"></script>
    <script src="Objects/container.js" type="module"></script>
    <script src="footer_admin.js"></script>

    <script type="module">
        // Importa las funciones necesarias del SDK de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configuración de Firebase obtenida de contactanos.html
        const firebaseConfig = {
            apiKey: "AIzaSyAuRQC65O5zlkNbcnp1srZkQpjmD82TVco",
            authDomain: "cienciometrik-3c8e7.firebaseapp.com",
            projectId: "cienciometrik-3c8e7",
            storageBucket: "cienciometrik-3c8e7.firebasestorage.app",
            messagingSenderId: "60232446009",
            appId: "1:60232446009:web:1ce1cbb0437018d62f9de8"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // Obtiene una referencia a la base de datos de Firestore

        const messagesContainer = document.getElementById('messages-container');
        const noMessagesText = document.getElementById('no-messages');

        let allMessages = []; // Para almacenar todos los mensajes recuperados de Firestore
        let currentFilterState = 'all'; // Estado actual del filtro (todos, leídos, no leídos, eliminados)
        let currentFilterDate = 'all'; // Estado actual del filtro por fecha (hoy, ayer, última semana, etc.)

        // Función para formatear la fecha de Timestamp de Firebase
        function formatFirebaseTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) {
                return 'Fecha desconocida';
            }
            const date = timestamp.toDate();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('es-ES', options);
        }

        // Función para obtener los mensajes de Firestore
        async function fetchMessages() {
            allMessages = []; // Limpiar mensajes anteriores
            noMessagesText.style.display = 'none'; // Ocultar el mensaje "No hay mensajes" por defecto
            messagesContainer.innerHTML = ''; // Limpiar el contenedor de mensajes

            try {
                // Consulta inicial para obtener todos los mensajes, ordenados por fecha descendente
                const q = query(collection(db, "mensajesContacto"), orderBy("fecha", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noMessagesText.style.display = 'block'; // Mostrar mensaje si no hay mensajes
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allMessages.push({
                        id: doc.id,
                        ...data,
                        read: data.read || false, // Añadir propiedad 'read' si no existe
                        deleted: data.deleted || false // Añadir propiedad 'deleted' si no existe
                    });
                });
                applyFiltersAndDisplayMessages(); // Aplicar filtros y mostrar mensajes iniciales
            } catch (error) {
                console.error("Error al obtener los mensajes: ", error);
                messagesContainer.innerHTML = '<p style="color: red;">Error al cargar los mensajes. Por favor, intente de nuevo.</p>';
            }
        }

        // Función para mostrar los mensajes en el DOM
        function displayMessages(messagesToDisplay) {
            messagesContainer.innerHTML = ''; // Limpiar el contenedor antes de añadir nuevos mensajes

            if (messagesToDisplay.length === 0) {
                noMessagesText.style.display = 'block';
                return;
            } else {
                noMessagesText.style.display = 'none';
            }

            messagesToDisplay.forEach(message => {
                const messageCard = document.createElement('div');
                messageCard.className = `message-card ${message.read ? 'read' : 'unread'} ${message.deleted ? 'deleted' : ''}`;
                messageCard.dataset.id = message.id; // Almacenar el ID del documento en el data-attribute

                const formattedDate = formatFirebaseTimestamp(message.fecha);

                messageCard.innerHTML = `
                    <div class="message-header">
                        <span class="message-status">${message.deleted ? 'Eliminado' : (message.read ? 'Leído' : 'No Leído')}</span>
                        <h3 class="message-subject">${message.asunto}</h3>
                        <span class="message-date">${formattedDate}</span>
                    </div>
                    <div class="message-meta">
                        <p><strong>De:</strong> ${message.nombre} &lt;${message.email}&gt;</p>
                        <p><strong>Tipo de consulta:</strong> ${message.tipoConsulta}</p>
                    </div>
                    <div class="message-body">
                        <p>${message.mensaje}</p>
                    </div>
                    <div class="message-actions">
                        ${!message.deleted ? `
                            <button class="action-btn mark-as-read-btn" data-id="${message.id}" ${message.read ? 'disabled' : ''}>
                                <i class="fas fa-eye"></i> ${message.read ? 'Leído' : 'Marcar como Leído'}
                            </button>
                            <button class="action-btn mark-as-unread-btn" data-id="${message.id}" ${!message.read ? 'disabled' : ''}>
                                <i class="fas fa-envelope-open"></i> Marcar como No Leído
                            </button>
                            <button class="action-btn delete-btn" data-id="${message.id}">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </button>
                        ` : `
                            <button class="action-btn restore-btn" data-id="${message.id}">
                                <i class="fas fa-undo"></i> Restaurar
                            </button>
                            <button class="action-btn permanently-delete-btn" data-id="${message.id}">
                                <i class="fas fa-times-circle"></i> Eliminar Permanentemente
                            </button>
                        `}
                    </div>
                `;
                messagesContainer.appendChild(messageCard);
            });

            addEventListenersToMessageActions(); // Añadir listeners a los botones después de crear las tarjetas
        }

        // Función para filtrar y mostrar mensajes
        function applyFiltersAndDisplayMessages() {
            let filteredMessages = [...allMessages]; // Trabajar con una copia para no modificar el original

            // Filtrar por estado
            if (currentFilterState === 'read') {
                filteredMessages = filteredMessages.filter(msg => msg.read && !msg.deleted);
            } else if (currentFilterState === 'unread') {
                filteredMessages = filteredMessages.filter(msg => !msg.read && !msg.deleted);
            } else if (currentFilterState === 'deleted') {
                filteredMessages = filteredMessages.filter(msg => msg.deleted);
            } else { // 'all'
                filteredMessages = filteredMessages.filter(msg => !msg.deleted); // Por defecto, no mostrar eliminados permanentemente
            }

            // Filtrar por fecha
            const now = new Date();
            filteredMessages = filteredMessages.filter(msg => {
                const messageDate = msg.fecha ? msg.fecha.toDate() : null;
                if (!messageDate) return false; // Si no hay fecha, no incluir

                switch (currentFilterDate) {
                    case 'today':
                        return messageDate.toDateString() === now.toDateString();
                    case 'yesterday':
                        const yesterday = new Date(now);
                        yesterday.setDate(now.getDate() - 1);
                        return messageDate.toDateString() === yesterday.toDateString();
                    case 'last-week':
                        const lastWeek = new Date(now);
                        lastWeek.setDate(now.getDate() - 7);
                        return messageDate >= lastWeek;
                    case 'last-month':
                        const lastMonth = new Date(now);
                        lastMonth.setMonth(now.getMonth() - 1);
                        return messageDate >= lastMonth;
                    case 'last-year':
                        const lastYear = new Date(now);
                        lastYear.setFullYear(now.getFullYear() - 1);
                        return messageDate >= lastYear;
                    case 'all':
                    default:
                        return true;
                }
            });

            displayMessages(filteredMessages);
        }

        // Función para manejar las acciones de los botones (marcar como leído, eliminar, etc.)
        async function handleMessageAction(action, messageId) {
            const messageRef = doc(db, "mensajesContacto", messageId);
            const messageIndex = allMessages.findIndex(msg => msg.id === messageId);

            if (messageIndex === -1) {
                console.error("Mensaje no encontrado en la lista local.");
                return;
            }

            try {
                if (action === 'read') {
                    await updateDoc(messageRef, { read: true });
                    allMessages[messageIndex].read = true;
                    console.log(`Mensaje ${messageId} marcado como leído.`);
                } else if (action === 'unread') {
                    await updateDoc(messageRef, { read: false });
                    allMessages[messageIndex].read = false;
                    console.log(`Mensaje ${messageId} marcado como no leído.`);
                } else if (action === 'delete') {
                    // Marcado lógico como eliminado
                    await updateDoc(messageRef, { deleted: true });
                    allMessages[messageIndex].deleted = true;
                    console.log(`Mensaje ${messageId} marcado para eliminación (lógica).`);
                } else if (action === 'restore') {
                    await updateDoc(messageRef, { deleted: false, read: false }); // Restaurar y marcar como no leído
                    allMessages[messageIndex].deleted = false;
                    allMessages[messageIndex].read = false;
                    console.log(`Mensaje ${messageId} restaurado.`);
                } else if (action === 'permanently-delete') {
                    const confirmDelete = confirm("¿Estás seguro de que quieres eliminar este mensaje PERMANENTEMENTE? Esta acción no se puede deshacer.");
                    if (confirmDelete) {
                        await deleteDoc(messageRef);
                        allMessages.splice(messageIndex, 1); // Eliminar del array local
                        console.log(`Mensaje ${messageId} eliminado permanentemente.`);
                    } else {
                        return; // No hacer nada si el usuario cancela
                    }
                }
                applyFiltersAndDisplayMessages(); // Volver a renderizar con los cambios
            } catch (error) {
                console.error(`Error al realizar la acción ${action} en el mensaje ${messageId}: `, error);
                alert(`Error al procesar la acción: ${error.message}`);
            }
        }

        // Función para añadir listeners a los botones de acción de los mensajes
        function addEventListenersToMessageActions() {
            messagesContainer.querySelectorAll('.mark-as-read-btn').forEach(button => {
                button.onclick = () => handleMessageAction('read', button.dataset.id);
            });
            messagesContainer.querySelectorAll('.mark-as-unread-btn').forEach(button => {
                button.onclick = () => handleMessageAction('unread', button.dataset.id);
            });
            messagesContainer.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = () => handleMessageAction('delete', button.dataset.id);
            });
            messagesContainer.querySelectorAll('.restore-btn').forEach(button => {
                button.onclick = () => handleMessageAction('restore', button.dataset.id);
            });
            messagesContainer.querySelectorAll('.permanently-delete-btn').forEach(button => {
                button.onclick = () => handleMessageAction('permanently-delete', button.dataset.id);
            });
        }

        // Event Listeners para los botones de filtro de estado
        document.getElementById('filter-all').addEventListener('click', () => {
            currentFilterState = 'all';
            document.querySelectorAll('.message-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-all').classList.add('active');
            applyFiltersAndDisplayMessages();
        });
        document.getElementById('filter-read').addEventListener('click', () => {
            currentFilterState = 'read';
            document.querySelectorAll('.message-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-read').classList.add('active');
            applyFiltersAndDisplayMessages();
        });
        document.getElementById('filter-unread').addEventListener('click', () => {
            currentFilterState = 'unread';
            document.querySelectorAll('.message-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-unread').classList.add('active');
            applyFiltersAndDisplayMessages();
        });
        document.getElementById('filter-deleted').addEventListener('click', () => {
            currentFilterState = 'deleted';
            document.querySelectorAll('.message-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-deleted').classList.add('active');
            applyFiltersAndDisplayMessages();
        });

        // Event Listeners para los botones de filtro de fecha
        document.getElementById('filter-today').addEventListener('click', () => {
            currentFilterDate = 'today';
            document.querySelectorAll('.date-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-today').classList.add('active');
            applyFiltersAndDisplayMessages();
        });
        document.getElementById('filter-yesterday').addEventListener('click', () => {
            currentFilterDate = 'yesterday';
            document.querySelectorAll('.date-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-yesterday').classList.add('active');
            applyFiltersAndDisplayMessages();
        });
        document.getElementById('filter-last-week').addEventListener('click', () => {
            currentFilterDate = 'last-week';
            document.querySelectorAll('.date-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-last-week').classList.add('active');
            applyFiltersAndDisplayMessages();
        });
        document.getElementById('filter-last-month').addEventListener('click', () => {
            currentFilterDate = 'last-month';
            document.querySelectorAll('.date-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-last-month').classList.add('active');
            applyFiltersAndDisplayMessages();
        });
        document.getElementById('filter-last-year').addEventListener('click', () => {
            currentFilterDate = 'last-year';
            document.querySelectorAll('.date-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-last-year').classList.add('active');
            applyFiltersAndDisplayMessages();
        });
        document.getElementById('filter-date-all').addEventListener('click', () => {
            currentFilterDate = 'all';
            document.querySelectorAll('.date-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-date-all').classList.add('active');
            applyFiltersAndDisplayMessages();
        });

        // Cargar los mensajes al cargar la página
        document.addEventListener('DOMContentLoaded', fetchMessages);
    </script>
</body>
</html>